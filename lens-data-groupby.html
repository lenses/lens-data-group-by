<link rel="import" href="../polymer/polymer.html"> 
<link rel="import" href="../lens-u-data-utility/lens-u-data-utility.html"> 
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">

<!--
A data component for grouping data by attributes and applying a function to filter the results.

##### Example

    <lens-data-groupby></lens-data-groupby>

@element lens-data-groupby
@blurb A data component for grouping data by attributes and applying a function to filter the results.
@status alpha
@homepage http://lenses.github.io/lens-data-groupby
-->

<dom-module id="lens-data-groupby">
  <link rel="stylesheet" href="lens-data-groupby.css">

  <template>
    <div class="lens-container">

      <lens-u-data-utility id="data_utility"></lens-u-data-utility>

        <p class="info">Group same values of a column together and apply function on others</p>
        <label class="label" for="func_selector">Group by column:</label>

        <iron-selector class="selector" id="value_selector" selected="{{groupByColumn}}" attr-for-selected="label">
          <template is="dom-repeat" items="{{_dataAttributes}}" as="attr">
            <div class="col" label="{{attr}}">{{attr}}</div>
          </template>
        </iron-selector>

        <label class="label" for="func_selector">Apply function:</label>
        <iron-selector class="selector" id="func_selector" selected="{{aggrFunction}}" attr-for-selected="label">
                  <div class="col" label="frequency">Frequency</div>
              <!--<template if="{{_whereColumnNumeric}}">-->
                <template is="dom-repeat" items="{{_numericFunctions}}" as="func">
                  <div class="col" label="{{func.label}}">{{func.name}}</div>
                </template>
              <!--</template>-->
        </iron-selector>
        <label class="label" for="func_selector">On column:</label>
        <iron-selector class="selector" id="value_selector" selected="{{aggrFuncOnColumn}}" attr-for-selected="label">
          <template is="dom-repeat" items="{{_dataAttributes}}" as="attr" index-as="attrIndex">
              <template is="dom-if" if="{{computeIf(_numericColumns)}}">
                <template is="dom-if" if="{{computeIf(attr, groupByColumn)}}">
                  <div class="col" label="{{attr}}">{{attr}}</div>
                </template>
              </template>
          </template>
        </iron-selector>
        <label class="label" for="sort_selector">Sort:</label>
        <iron-selector class="selector" id="func_selector" selected="{{sortValues}}" attr-for-selected="label">
            <div class="col" label="none">None</div>
            <div class="col" label="asc">Ascending</div>
            <div class="col" label="desc">Descending</div>
        </iron-selector>
      </div>
    </template>
</dom-module>
<script>

  Polymer({
    is: 'lens-data-groupby',
    properties: {
      _numericColumns: {
        type: Array,
        value: function () {
          return [];
        }
      },
      _numericFunctions: {
        type: Array,
        value: function () {
          return [
            {
              label: 'max',
              name: 'Max'
            },
            {
              label: 'min',
              name: 'Min'
            },
            {
              label: 'sum',
              name: 'Sum'
            },
            {
              label: 'avg',
              name: 'Average'
            }
          ];
        }
      },
      _dataAttributes: {
        type: Array,
        value: []
      },
      aggrFuncOnColumn: {
        notify: true,
        observer: 'aggrFuncOnColumnChanged'
      },
      aggrFunction: {
        type: String,
        value: 'frequency',
        notify: true,
        observer: 'aggrFunctionChanged'
      },
      groupByColumn: {
        notify: true,
        observer: 'groupByColumnChanged'
      },
      included: {
        type: Boolean,
        value: false,
        notify: true
      },
      input: {
        notify: true,
        observer: 'inputChanged'
      },
      output: { notify: true },
      sortValues: {
        type: String,
        value: 'none',
        notify: true,
        observer: 'sortValuesChanged'
      }
    },
    ready: function () {
      //open the collapse if it the component is included
      if (this.included && !this.$.ctrl_collapse.opened) {
        this.$.ctrl_collapse.toggle();
      }
    },
    _calculateOutput: function () {
      var self = this;  //don't calculate anything if it is just included in another component
      //don't calculate anything if it is just included in another component
      if (this.included) {
        return;
      }
      if (self.groupByColumn && self.groupByColumn !== 'none') {
        if (!self.aggrFunction || self.aggrFunction === 'frequency') {
          var temp = _.countBy(self.input, self.groupByColumn);
          var keys = Object.keys(temp);
          self.output = _.map(keys, function (key) {
            return {
              label: key,
              value: temp[key]
            };
          });
        } else {
          var temp = _.groupBy(self.input, self.groupByColumn);
          var aggrFunction = self.$.data_utility.aggregateFunctions[self.aggrFunction];
          self.output = _.map(temp, function (value, key) {
            //var ret = {};
            //ret[key] = aggrFunction(value, self.aggrFuncOnColumn)
            ret = {
              label: key,
              value: aggrFunction(value, self.aggrFuncOnColumn)
            };
            return ret;
          });
        }
        if (self.sortValues !== 'none') {
          self.output = _.sortBy(self.output, 'value');
          if (self.sortValues === 'desc') {
            self.output.reverse();
          }
        }
      }

      self.fire('lens-output-changed', this.output);
    },
    inputChanged: function () {
      var self = this;
      var firstItem = self.input[0];
      if (!firstItem) {
        return;
      }
      var attributes = Object.keys(firstItem);
      if (JSON.stringify(self._dataAttributes) === JSON.stringify(attributes)) {
      }  //self._mapChartData();
      else
        //self._mapChartData();
        {
          self._dataAttributes = attributes;
        }
      self._findNumericalColumns();
      self._calculateOutput();
    },
    _findNumericalColumns: function () {
      var self = this;
      self._dataAttributes.forEach(function (key, index) {
        var isNum = self.$.data_utility.isColumnNumeric(self.input, key);  //TODO fix bugs related to isColumnNumeric and put back the check.
        //TODO fix bugs related to isColumnNumeric and put back the check.
        self._numericColumns[index] = true;  //isNum;
      });
    },
    //isNum;
    aggrFunctionChanged: function () {
      this._calculateOutput();
    },
    sortValuesChanged: function () {
      //or just sort?
      this._calculateOutput();
    },
    groupByColumnChanged: function () {
      console.log(this.groupByColumn);
      this._calculateOutput();
    },
    aggrFuncOnColumnChanged: function () {
      this._calculateOutput();
    },
    computeIf: function (included) {
      return !included;
    },
    computeIf: function (_numericColumns) {
      return _numericColumns[attrIndex];
    },
    computeIf: function (attr, groupByColumn) {
      return attr !== groupByColumn;
    }
  });
</script><script src="../lodash/lodash.js"></script>